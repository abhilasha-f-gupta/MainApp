name: Update ReferenceAppPackage

on:
  repository_dispatch:
    types: [reference-package-released]

jobs:
  update-package:
    runs-on: macos-latest

    steps:
      # Checkout MainApp repo
      - name: Checkout MainApp
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.PAT_TOKEN }}

      # Read the new version from the event payload
      - name: Read new version
        id: vars
        run: |
          echo "VERSION=${{ github.event.client_payload.version }}" >> $GITHUB_ENV
          echo "New version: ${{ github.event.client_payload.version }}"

      # Update the version in the .pbxproj file
      - name: Update ReferenceAppPackage version in Xcode project
        run: |
          echo "Updating ReferenceAppPackage to version ${VERSION} in project.pbxproj"
          sed -i '' -E "s/(minimumVersion = )[0-9]+\.[0-9]+\.[0-9]+/\1${VERSION}/" MainApp.xcodeproj/project.pbxproj
          
          echo "Changed lines:"
          grep "minimumVersion" MainApp.xcodeproj/project.pbxproj

      # Commit and push only if changes exist
      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git checkout -b update-package-to-${VERSION}
          if git diff --quiet; then
            echo "No version change detected, skipping commit and PR creation."
            exit 0
          fi

          git add MainApp.xcodeproj/project.pbxproj
          git commit -m "Update ReferenceAppPackage to version ${VERSION}"
          git push origin update-package-to-${VERSION}

      # Create Pull Request
      - name: Create Pull Request
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          gh pr create \
            --head "update-package-to-${VERSION}" \
            --base "main" \
            --title "Update ReferenceAppPackage to ${VERSION}" \
            --body "This PR updates ReferenceAppPackage to version ${VERSION}."
